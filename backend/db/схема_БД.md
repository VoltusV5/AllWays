<br><br>

# Таблица: users (Пользователи)

name           | type      | description
---------------|-----------|------------------------------------------
id             | INT (PK)  | Уникальный идентификатор пользователя
email          | VARCHAR   | Электронная почта пользователя
password_hash  | VARCHAR   | Хэш пароля пользователя
is_active      | BOOLEAN   | Флаг активности (TRUE = пользователь может входить в систему, то есть он не забанен, его аккаунт актуален)
created_at     | DATE      | Дата создания пользователя
updated_at     | DATE      | Дата последнего изменения записи
last_login     | DATETIME  | Время последнего успешного входа
failed_attempts| INT       | Количество неудачных попыток входа
email_verified | BOOLEAN   | Подтверждён ли email

<br><br><br><br>

# Таблица: social_logins (вход через другие сервисы)
name           | type      | description
---------------|-----------|------------------------------------------
user_id      | INT (FK) | Ссылка на пользователя
provider     | VARCHAR  | Название сервиса (Google, VK, Yandex, Mail.ru, etc.)
provider_id  | VARCHAR  | ID пользователя в сервисе
created_at   | DATETIME | Дата и время подключения

<br><br><br><br>

# Таблица: login_history (отслеживание входов)
name           | type      | description
---------------|-----------|------------------------------------------
id        | INT (PK)    | айди входа
user_id   | INT (FK) → users.id
login_at  | DATETIME    | время
ip        | VARCHAR     | айпи
device    | VARCHAR     | устройство
browser   | VARCHAR     | браузер
success   | BOOLEAN     | статус входа

<br><br><br><br>

# Таблица: notifications (уведомления, личные сообщения пользователю)
name           | type      | description
---------------|-----------|------------------------------------------
id           | INT (PK) | айди уведомления
user_id      | INT (FK) → users.id
type         | VARCHAR  | (info, booking_update, promo, reminder)
message      | TEXT     | текст сообщения
related_id   | INT      | (например, booking_id, route_id)
created_at   | DATETIME | когда отправлен
read         | BOOLEAN  | прочитан или нет


<br><br><br><br>

# Таблица: roles (Роли)
name  | type      | description
------|-----------|-----------------------------------
id    | INT (PK)  | Уникальный идентификатор роли
name  | VARCHAR   | Название роли

<br><br><br><br>

# Таблица: user_roles (Пользовательские роли)
name     | type      | description
---------|-----------|--------------------------------------
id       | INT (PK)  | Уникальный идентификатор записи роли пользователя
user_id  | INT (FK)  | Ссылка на пользователя (users.id)
role_id  | INT (FK)  | Ссылка на роль (roles.id)

<br><br><br><br>

# Таблица: user_routes(история поездок пользователя)
name  | type      | description
------|-----------|-----------------------------------
user_id      | INT (FK)  | Ссылка на пользователя
route_type   | VARCHAR   | Тип маршрута (from_to = откуда→куда, to_only = только куда)
start_stop   | INT (FK)  | Ссылка на stop_from (для from_to)
end_stop     | INT (FK)  | Ссылка на stop_to
created_at   | DATETIME  | Время выбора маршрута
duration     | INT       | Время в пути (в минутах)
distance_km  | INT       | Расстояние сегмента в километрах

<br><br><br><br>

# Таблица: profiles (Личные данные пользователя)
name       | type       | description
-----------|------------|--------------------------------------
user_id    | INT (PK, FK)| Ссылка на пользователя (users.id), один к одному
full_name  | VARCHAR    | Полное имя пользователя
birthday   | DATE       | Дата рождения пользователя
timezone   | VARCHAR    | Часовой пояс пользователя
preferences| JSON       | Настройки аккаунта пользователя 
account_level | VARCHAR (FK)| Уровень аккаунта (Gold, Silver, Bronze и т.д.)

<br><br><br><br>

# Таблица: account_levels (уровень аккаунта)
name  | type      | description
------|-----------|-----------------------------------
id            | INT (PK)  |
name          | VARCHAR   | Название уровня (Gold, Silver, Bronze)
description   | TEXT      | Описание преимуществ уровня
bonus_percent | INT       | Процент бонусов или скидки




<br><br><br><br>

# Таблица: bookings (Данные о бронировании, сюда записываются все билеты)
name        | type      | description
------------|-----------|-----------------------------------------
id          | INT (PK)  | Уникальный идентификатор бронирования
user_id     | INT (FK)  | Пользователь, оформивший бронирование
created_at  | DATE      | Дата создания бронирования
status      | VARCHAR   | Статус бронирования (новое, оплачено, отменено)
booking_expiry | DATETIME | время, до которого бронирование действительно. После него заявка пользователя удаляется
promo_code  | VARCHAR (FK) | Промокоды 
discount_amount | INT | Скидка
seat_class  | VARCHAR | класс билета (эконом, бизнес, первый).
luggage_info | TEXT |   информация о багаже.
group_booking_id | INT | ссылка на бронирование группы (несколько пользователей под одним заказом).

<br><br><br><br>

# Таблица: promotions (Информация о промокодах)
name        | type      | description
------------|-----------|-----------------------------------------
id | INT (PK) | 
promo_valid_until | DATETIME (PK) | срок действия промо-кода.
promo_min_booking_amount | DECIMAL | минимальная сумма бронирования, при которой промо применяется.
max_uses | INT | Максимальное число применений
user_limit | INT | ограничение на количество использований одним пользователем.

<br><br><br><br>

# Таблица: loyalty_programs (программа лояльности)
name        | type      | description
------------|-----------|-----------------------------------------
id | INT (PK) | 
user_id | INT (FK) |
program_name | (VARCHAR)|  — "Бонусная карта", "Miles&More", "Cashback"
points_balance | INT | текущий баланс бонусов.
points_earned | INT |  начисленные баллы.
points_spent | INT |   потраченные баллы.
last_update | DATETIME | последнее обновление

<br><br><br><br>



# Таблица: bookings_history (История изменений бронирования)
name        | type      | description
------------|-----------|-----------------------------------------
booking_id      | INT (FK)  | Ссылка на бронирование (bookings.id)
changed_at      | DATETIME  | Время изменения
changed_by      | INT (FK)  | Кто сделал изменение (user_id)
change_type     | VARCHAR   | Тип изменения (создание, изменение, отмена)
old_status      | VARCHAR   | Старый статус
new_status      | VARCHAR   | Новый статус

<br><br><br><br>

# Таблица: tickets (данные билетов бронирования)
name           | type      | description
---------------|-----------|------------------------------------------
id             | INT (PK)  | Уникальный идентификатор билета
booking_id     | INT (FK)  | Ссылка на бронирование (bookings.id)
passenger_name | VARCHAR   | Имя пассажира
seat_number    | VARCHAR   | Номер места (если применимо)
issued_at      | DATE      | Дата выдачи билета

<br><br><br><br>

# Таблица: payments (Оплата билетов)
name        | type      | description
------------|-----------|-----------------------------------------
id          | INT (PK)  | Уникальный идентификатор платежа
booking_id  | INT (FK)  | Ссылка на бронирование (bookings.id)
amount      | INT       | Сумма платежа в минимальных единицах (например, копейки)
status      | VARCHAR   | Статус платежа (ожидается, успешен, отклонен)
paid_at     | DATE      | Дата и время оплаты
payment_method  | VARCHAR   | Метод оплаты (карта, кошелёк, бонусы)
currency        | VARCHAR   | Валюта платежа (например, RUB, USD)
refund_status   | VARCHAR   | возврат (pending, completed, failed).
transaction_id  | VARCHAR   | ID платежа в системе.
payment_gateway | VARCHAR   | через какую систему прошёл платёж (Stripe, PayPal, Яндекс и т.п.).
loyalty_points_used | INT   | сколько бонусных баллов применил пользователь.

<br><br><br><br>

# Таблица: payments (Оплата билетов)
name        | type      | description
------------|-----------|-----------------------------------------
id |(PK)|
user_id |(FK → users.id)|
booking_id |(FK → bookings.id, NULLABLE)| — если файл относится к бронированию
review_id |(FK → reviews.id, NULLABLE)| — если файл относится к отзыву
file_url |(TEXT)| — путь до файла (S3, локально и т.п.)
file_type |(VARCHAR)| — image, pdf, doc
uploaded_at |(TIMESTAMP, DEFAULT now())|

<br><br><br><br>

# Таблица: route_filters (Фильтры для видов транспорта)
name           | type      | description
------------   |-----------|-----------------------------------------
route_id       | INT (FK) | Ссылка на маршрут (routes.id)
transport_type | VARCHAR  | Тип транспорта (например: автобус, поезд, самолёт)

<br><br><br><br>

# Таблица: providers (Данные перевозчика)
name         | type      | description
-------------|-----------|------------------------------------------
id           | INT (PK)  | Уникальный идентификатор перевозчика
name         | VARCHAR   | Название транспортной компании
contact_info | VARCHAR   | Контактная информация (телефон, email)

<br><br><br><br>

# Таблица: routes (Маршруты)
name         | type      | description
-------------|-----------|------------------------------------------
id           | INT (PK)  | Уникальный идентификатор маршрута
provider_id  | INT (FK)  | Ссылка на перевозчика (providers.id)
name         | VARCHAR   | Название маршрута (например: Москва–СПб)

<br><br><br><br>

# Таблица: stops (Остановки у маршрута: конечная и начальная точка сегмента)
name      | type    | description
----------|---------|-----------------------------------
id        | INT (PK)| Уникальный идентификатор остановки
name      | VARCHAR | Название остановки
latitude  | VARCHAR | Географическая широта
longitude | VARCHAR | Географическая долгота

<br><br><br><br>

# Таблица: segments (Сегменты для маршрута)
name         | type      | description
-------------|-----------|------------------------------------------
id           | INT (PK)  | Уникальный идентификатор сегмента маршрута
route_id     | INT (FK)  | Ссылка на маршрут (routes.id)
stop_from_id | INT (FK)  | Начальная остановка (stops.id)
stop_to_id   | INT (FK)  | Конечная остановка (stops.id)
duration     | INT       | Время в пути (в минутах)
distance_km  | INT       | Расстояние сегмента в километрах

<br><br><br><br>

# Таблица: segment_transport (конкретная информация о перевозчике, транспорте и стоимости сегмента)
name           | type      | description
------------   |-----------|-----------------------------------------
segment_id     | INT (FK) → segments.id
provider_id    | INT (FK) → providers.id
transport_type | VARCHAR   | Тип транспорта
price          | INT       | Цена сегмента маршрута
distance_km    | INT       | дистанция сегмента маршрута
duration_min   | INT       | время поездки для сегмента маршрута
segment_status | VARCHAR   | статус сегмента (активный, отменённый, задержан).

<br><br><br><br>

# Таблица: schedules (таблица, соединяющая разные сегменты маршрута)
name           | type      | description
---------------|-----------|------------------------------------------
id             | INT (PK)  | Уникальный идентификатор записи расписания
segment_id     | INT (FK)  | Ссылка на сегмент маршрута (segments.id)
departure_time | DATE      | Время отправления
arrival_time   | DATE      | Время прибытия

<br><br><br><br>

# Таблица: audit_logs (отслеживания действий в системе (важно для безопасности, админки и расследований))
name           | type      | description
---------------|-----------|------------------------------------------
id (PK) |
user_id |(FK → users.id) |— кто совершил действие
action |(TEXT) | — какое действие (создал бронирование, изменил, отменил и т.п.)
entity_type| (TEXT)| — над какой сущностью (booking, payment, route)
entity_id |(INT)| — ID сущности
timestamp| DATETIME |
ip_address| (VARCHAR)| — IP
device_info| (VARCHAR)| — устройство / браузер

<br><br><br><br>

# Таблица: route_reviews (отзывы на маршруты)
name           | type      | description
---------------|-----------|------------------------------------------
id             | INT (PK)  | айди отзыва
route_id       | INT (FK) → routes.id
user_id        | INT (FK) → users.id
rating         | INT       | Рейтинг маршрута
review         | TEXT      | Комментарий отзыва
created_at     | DATETIME  | дата создания отзыва
review_images  | JSON      | изображения, прикреплённые к отзыву.


# Общее описание работы:

``` bash
# 1. Пользователи и роли

Таблица users хранит информацию о пользователях.
Поле is_active (по желанию) показывает, может ли пользователь входить в систему.
Таблица roles хранит возможные роли (администратор, клиент и т.д.).
Таблица user_roles связывает пользователей и роли (многие ко многим).

Пример взаимодействия:
Один пользователь может иметь несколько ролей.
Одна роль может быть присвоена нескольким пользователям.

# 2. Профили

Таблица profiles хранит расширенную информацию о пользователях: имя, дату рождения и т.д.
Связь users → profiles 1:1.
Один профиль соответствует только одному пользователю.

# 3. Бронирования и билеты
Таблица bookings хранит каждое бронирование пользователя (например, покупку билетов).
Связь users → bookings 1:N — один пользователь может делать несколько бронирований.

Таблица tickets хранит отдельные билеты для бронирования.
Связь bookings → tickets 1:N — одно бронирование может содержать несколько билетов.

Пример:
Пользователь купил 3 билета — создаётся одно бронирование, три записи в tickets.

# 4. Платежи
Таблица payments хранит оплату бронирований.
Связь bookings → payments 1:N — одно бронирование может иметь несколько платежей (например, частичная оплата или возврат).

# 5. Перевозчики, маршруты, сегменты и расписания
Таблица providers хранит транспортные компании.

Таблица routes хранит маршруты, связанные с перевозчиком (providers → routes 1:N).

Таблица segments описывает сегменты маршрута (например, часть пути между остановками).
Связь routes → segments 1:N
Каждая остановка участвует в сегментах (stops → segments 1:N, два поля: stop_from_id и stop_to_id)

Таблица schedules хранит время отправления и прибытия сегментов (segments → schedules 1:N)

Пример взаимодействия:
Автобусная компания (providers) имеет маршрут Москва–СПб (routes).
Маршрут делится на сегменты, например Москва–Тверь, Тверь–СПб (segments).
Для каждого сегмента создаётся расписание (schedules).

# 6. Общая логика
Пользователь создаёт аккаунт (users + profiles).
Пользователь делает бронирование (bookings).
Для бронирования создаются билеты (tickets).
Пользователь оплачивает бронирование (payments).
Билеты привязаны к конкретным сегментам маршрута через маршруты и расписания.
Все маршруты связаны с перевозчиками (providers) и остановками (stops).

# 💡 Итог:
users — центральная таблица, вокруг неё строятся профили, бронирования и роли.
bookings → tickets → payments — логика покупки и оплаты билетов.
providers → routes → segments → schedules — логика маршрутов и расписаний.

Взаимосвязь таблиц позволяет легко:
- Узнать все бронирования пользователя
- Получить билеты и платежи
- Просмотреть маршруты и их расписание










last_login и failed_attempts

last_login — хранит время последнего успешного входа пользователя.
failed_attempts — количество подряд неудачных попыток входа.

Как это защищает от взлома:
Если failed_attempts превышает порог (например, 5 попыток), аккаунт можно временно заблокировать.

last_login помогает выявлять подозрительную активность (например, вход с другого IP/места).

После успешного входа failed_attempts сбрасывается в 0.

Пример логики:

user_id	    failed_attempts	    last_login
101	3	    2025-08-23          12:00
Если пользователь вводит неверный пароль → failed_attempts += 1
Если верный → failed_attempts = 0 и last_login = текущее время
```
